<?xml version="1.0" encoding="UTF-8"?>
<Schema name="datachile">
  <Dimension name="Date" type="TimeDimension">
    <Hierarchy hasAll="true" primaryKey="id">
      <Table schema="public" name="dim_date" />
      <Level column="the_year" levelType="TimeYears" name="Year" type="Numeric" uniqueMembers="true"/>
      <Level column="month_of_year" levelType="TimeMonths" name="Month" type="Numeric" uniqueMembers="false" />
      <Level column="day_of_month" levelType="TimeDays" name="Day" type="Numeric" uniqueMembers="false" />
    </Hierarchy>
  </Dimension>

  <Dimension name="Geography">
    <Hierarchy hasAll="true" primaryKey="id">
      <Table name="dim_comunas" schema="public" />
      <Level name="Region" column="region_id" nameColumn="region_name" uniqueMembers="true" />
      <Level name="Comuna" column="comuna_datachile_id" nameColumn="comuna_name" uniqueMembers="true"  />
    </Hierarchy>
  </Dimension>

  <Dimension name="Country">
    <Hierarchy hasAll="true" primaryKey="country_code">
      <Table name="dim_countries" schema="public" />
      <Level name="Country" column="country_code" nameColumn="country_name" uniqueMembers="true" />
    </Hierarchy>
  </Dimension>

  <Dimension name="HS">
    <Hierarchy hasAll="true" primaryKey="level3">
      <Table name="hs_levels" schema="economy" />
      <Level name="HS0" column="level0" nameColumn="level0_name" uniqueMembers="true" />
      <Level name="HS2" column="level1" nameColumn="level1_name" uniqueMembers="true" />
      <Level name="HS4" column="level2" nameColumn="level2_name" uniqueMembers="true" />
      <Level name="HS6" column="level3" nameColumn="level3_name" uniqueMembers="true" />
    </Hierarchy>
  </Dimension>

  <Dimension name="ISICrev4">
    <Hierarchy hasAll="true" primaryKey="level4">
      <Table name="dim_isic" schema="public" />
      <Level name="Level 1" column="level1" nameColumn="level1_description" uniqueMembers="true" />
      <Level name="Level 2" column="level2" nameColumn="level2_description" uniqueMembers="true" />
      <Level name="Level 3" column="level3" nameColumn="level3_description" uniqueMembers="true" />
      <Level name="Level 4" column="level4" nameColumn="level4_description" uniqueMembers="true" />
    </Hierarchy>
  </Dimension>

  <Cube name="exports">
    <Table name="pg_exports" schema="economy">
      <AggName name="datachile_exports_1">
        <AggFactCount column="pg_exports_fact_count">
        </AggFactCount>
        <AggMeasure column="pg_exports_Q_Traded" name="[Measures].[Q Traded]">
        </AggMeasure>
        <AggMeasure column="pg_exports_FOB_US" name="[Measures].[FOB US]">
        </AggMeasure>
        <AggLevel column="dim_date_Year" name="[Date].[Year]">
        </AggLevel>
        <AggLevel column="dim_countries_Country_(Key)" name="[Destination Country].[Country]">
        </AggLevel>
      </AggName>
      <AggName name="datachile_exports_2">
        <AggFactCount column="pg_exports_fact_count">
        </AggFactCount>
        <AggMeasure column="pg_exports_Q_Traded" name="[Measures].[Q Traded]">
        </AggMeasure>
        <AggMeasure column="pg_exports_FOB_US" name="[Measures].[FOB US]">
        </AggMeasure>
        <AggLevel column="dim_date_Year" name="[Date].[Year]">
        </AggLevel>
        <AggLevel column="hs_levels_HS0_(Key)" name="[HS].[HS0]">
        </AggLevel>
      </AggName>
      <AggName name="datachile_exports_3">
        <AggFactCount column="pg_exports_fact_count">
        </AggFactCount>
        <AggMeasure column="pg_exports_Q_Traded" name="[Measures].[Q Traded]">
        </AggMeasure>
        <AggMeasure column="pg_exports_FOB_US" name="[Measures].[FOB US]">
        </AggMeasure>
        <AggLevel column="dim_date_Year" name="[Date].[Year]">
        </AggLevel>
        <AggLevel column="dim_comunas_Region_(Key)" name="[Export Geography].[Region]">
        </AggLevel>
        <AggLevel column="hs_levels_HS0_(Key)" name="[HS].[HS0]">
        </AggLevel>
        <AggLevel column="hs_levels_HS2_(Key)" name="[HS].[HS2]">
        </AggLevel>
      </AggName>
    </Table>

    <DimensionUsage name="Date" source="Date" foreignKey="date_id" />
    <DimensionUsage name="Destination Country" source="Country" foreignKey="country_dest_id" />
    <DimensionUsage name="Export Geography" source="Geography" foreignKey="exporter_comuna_id" />
    <DimensionUsage name="HS" source="HS" foreignKey="hs_level3" />

    <Measure name="Q Traded" column="q_traded" aggregator="sum" />
    <Measure name="FOB US" column="fob_us" aggregator="sum" />

    <CalculatedMember name="Geo Rank" dimension="Measures">
      <Formula>
        IIf(IsEmpty([Measures].[FOB US]),
          Null,
          Rank([Export Geography].CurrentMember,
               Order([Export Geography].CurrentMember.Siblings,
               Measures.[FOB US], BDESC)))
      </Formula>
    </CalculatedMember>

    <CalculatedMember name="Geo Rank Across Time" dimension="Measures">
      <Annotations>
        <Annotation name="description">Rank of this particularly geography across all its siblings, by time</Annotation>
      </Annotations>
      <Formula>
        Rank([Export Geography].CurrentMember,
          Order([Export Geography].CurrentMember.Siblings,
                Aggregate({[Date].CurrentMember}*{[Destination Country].[All Destination Countrys]}*{[HS].[All HSs]},
                          [Measures].[FOB US]),
                BDESC))

      </Formula>
    </CalculatedMember>

  </Cube>

  <Cube name="imports">
    <Table name="pg_imports" schema="economy">
      <AggName name="datachile_imports_2">
        <AggFactCount column="pg_imports_fact_count">
        </AggFactCount>
        <AggMeasure column="pg_imports_CIF_US" name="[Measures].[CIF US]">
        </AggMeasure>
        <AggLevel column="dim_date_Year" name="[Date].[Year]">
        </AggLevel>
        <AggLevel column="dim_countries_Country_(Key)" name="[Origin Country].[Country]">
        </AggLevel>
        <AggLevel column="hs_levels_HS0_(Key)" name="[HS].[HS0]">
        </AggLevel>
      </AggName>
      <AggName name="datachile_imports_5">
        <AggFactCount column="pg_imports_fact_count">
        </AggFactCount>
        <AggMeasure column="pg_imports_CIF_US" name="[Measures].[CIF US]">
        </AggMeasure>
        <AggLevel column="dim_date_Year" name="[Date].[Year]">
        </AggLevel>
        <AggLevel column="dim_comunas_Region_(Key)" name="[Import Geography].[Region]">
        </AggLevel>
        <AggLevel column="hs_levels_HS0_(Key)" name="[HS].[HS0]">
        </AggLevel>
        <AggLevel column="hs_levels_HS2_(Key)" name="[HS].[HS2]">
        </AggLevel>
      </AggName>
    </Table>
    <DimensionUsage name="Date" source="Date" foreignKey="date_id" />
    <DimensionUsage name="Origin Country" source="Country" foreignKey="country_origin_id" />
    <DimensionUsage name="Import Geography" source="Geography" foreignKey="importer_comuna_id" />
    <DimensionUsage name="HS" source="HS" foreignKey="hs_6digits" />

    <Measure name="CIF US" column="cif_us" aggregator="sum" />

    <CalculatedMember name="Geo Rank Across Time" dimension="Measures">
      <Annotations>
        <Annotation name="description">Rank of this particularly geography across all its siblings, by time</Annotation>
      </Annotations>
      <Formula>
        Rank([Import Geography].CurrentMember,
          Order([Import Geography].CurrentMember.Siblings,
                Aggregate({[Date].CurrentMember}*{[Origin Country].[All Origin Countrys]}*{[HS].[All HSs]},
                          [Measures].[CIF US]),
                BDESC))

      </Formula>
    </CalculatedMember>

  </Cube>

  <Cube name="tax_data">
    <Table name="tax_data" schema="economy" />
    <DimensionUsage name="Date" source="Date" foreignKey="date_id" />
    <DimensionUsage name="Geography" source="Geography" foreignKey="comuna_id" />
    <DimensionUsage name="ISICrev4" source="ISICrev4" foreignKey="ciiu4_ori" />

    <Measure name="Output" column="output" aggregator="sum" />
    <Measure name="Labour" column="labour" aggregator="sum" />
    <Measure name="Labour Cost" column="labour_cost" aggregator="sum" />
    <Measure name="Investment" column="investment" aggregator="sum" />
    <Measure name="Intermediates" column="intermediates" aggregator="sum" />
  </Cube>

  <VirtualCube name="exports_and_imports" defaultMeasure="Trade Balance">
    <VirtualCubeDimension name="Date" />
    <VirtualCubeDimension name="Geography" />
    <VirtualCubeDimension name="HS" />
    <VirtualCubeMeasure cubeName="exports" name="[Measures].[FOB US]" />
    <VirtualCubeMeasure cubeName="imports" name="[Measures].[CIF US]" />

    <CalculatedMember name="Trade Balance" dimension="Measures">
      <Formula>[Measures].[FOB US] - [Measures].[CIF US]</Formula>
    </CalculatedMember>
  </VirtualCube>
</Schema>
